<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>벽돌깨기 게임 with BGM</title>
<style>
  body {
    margin: 0; background: #222; color: #eee; font-family: Arial, sans-serif;
    display: flex; flex-direction: column; align-items: center; height: 100vh;
  }
  canvas {
    border: 2px solid #fff;
    background: #111;
    display: block;
    margin-top: 10px;
  }
  #controls {
    margin-top: 10px;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
    user-select: none;
  }
  button, select {
    padding: 6px 12px;
    font-size: 14px;
    border-radius: 4px;
    border: none;
    cursor: pointer;
    background: #444;
    color: #eee;
    transition: background 0.3s;
  }
  button:disabled, select:disabled {
    background: #222;
    cursor: not-allowed;
    color: #666;
  }
  button:hover:not(:disabled), select:hover:not(:disabled) {
    background: #666;
  }
  #scoreboard {
    margin-top: 10px;
    font-size: 18px;
    display: flex;
    gap: 20px;
  }
  /* 모바일 좌우버튼 */
  #mobile-buttons {
    margin-top: 10px;
    display: flex;
    gap: 12px;
    justify-content: center;
  }
  .mob-btn {
    width: 60px;
    height: 40px;
    font-size: 18px;
    border-radius: 6px;
    background: #555;
    color: #eee;
    user-select: none;
  }
</style>
</head>
<body>

<h1>벽돌깨기 게임 with BGM</h1>

<div id="scoreboard">
  <div>점수: <span id="score">0</span></div>
  <div>최고점수: <span id="highscore">0</span></div>
  <div>레벨: <span id="level">1</span></div>
</div>

<canvas id="gameCanvas" width="480" height="320"></canvas>

<div id="controls">
  <select id="difficultySelect" title="난이도 선택">
    <option value="easy">쉬움</option>
    <option value="normal" selected>보통</option>
    <option value="hard">어려움</option>
  </select>
  <button id="startBtn" title="게임 시작">시작하기</button>
  <button id="restartBtn" title="게임 다시 시작" disabled>다시하기</button>
  <button id="bgmToggleBtn" title="배경음악 ON/OFF">BGM ON</button>
</div>

<div id="mobile-buttons">
  <button class="mob-btn" id="btnLeft">◀</button>
  <button class="mob-btn" id="btnRight">▶</button>
</div>

<!-- 배경음악 -->
<audio id="bgm" src="ads/Tetris.mp3" loop preload="auto"></audio>

<!-- 효과음 -->
<audio id="hitSound" src="ads/linebroken1.wav" preload="auto"></audio>
<audio id="gameOverSound" src="ads/linebroken2.wav" preload="auto"></audio>

<script>
(() => {
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const scoreElem = document.getElementById("score");
  const highscoreElem = document.getElementById("highscore");
  const levelElem = document.getElementById("level");
  const difficultySelect = document.getElementById("difficultySelect");
  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");
  const btnLeft = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");
  const bgmToggleBtn = document.getElementById("bgmToggleBtn");

  const hitSound = document.getElementById("hitSound");
  const gameOverSound = document.getElementById("gameOverSound");
  const bgm = document.getElementById("bgm");

  // 게임 상태 변수
  let score = 0;
  let highscore = localStorage.getItem("brickBreakerHighscore") || 0;
  highscore = Number(highscore);
  let level = 1;
  let isGameOver = false;

  // 패들 변수
  let paddleHeight = 10;
  let paddleWidth = 75;
  let paddleX = (canvas.width - paddleWidth) / 2;

  // 공들 배열 (멀티볼 지원)
  let balls = [];

  // 공 기본 속도
  let baseSpeed = 3;

  // 좌우 조작 상태
  let rightPressed = false;
  let leftPressed = false;
  let mobileRight = false;
  let mobileLeft = false;

  // 벽돌 설정
  let brickRowCount = 5;
  let brickColumnCount = 7;
  let brickWidth = 55;
  let brickHeight = 20;
  let brickPadding = 7;
  let brickOffsetTop = 30;
  let brickOffsetLeft = 25;

  // 벽돌 배열
  let bricks = [];

  // 아이템 종류
  const ITEM_NONE = 0;
  const ITEM_PADDLE_EXPAND = 1;
  const ITEM_PADDLE_SHRINK = 2;
  const ITEM_SCORE_BONUS = 3;
  const ITEM_BALL_SPEED_SLOW = 4;
  const ITEM_BALL_SPEED_FAST = 5;
  const ITEM_BALL_EXTRA = 6;

  // 아이템 효과 지속시간 (밀리초)
  const ITEM_DURATION = 10000;

  // 현재 활성 아이템 상태
  let activeItems = {
    paddleSizeModifier: 0,  // +1 : 확장, -1 : 축소, 0 : 기본
    ballSpeedModifier: 0,   // +1 : 빠름, -1 : 느림, 0 : 기본
    ballExtraActive: false, // 멀티볼 활성 여부
    itemTimeouts: []
  };

  // 아이템 블록 생성 확률 (%)
  const ITEM_BLOCK_CHANCE = 15;

  // 게임 오버 상태 시 컨트롤 비활성화 플래그
  let controlsDisabled = false;

  // 게임 보더 흰색
  canvas.style.border = "2px solid white";

  // 초기 UI 설정
  scoreElem.textContent = score;
  highscoreElem.textContent = highscore;
  levelElem.textContent = level;

  // 벽돌 초기화 함수
  function resetBricks() {
    bricks = [];
    for(let c = 0; c < brickColumnCount; c++) {
      bricks[c] = [];
      for(let r = 0; r < brickRowCount; r++) {
        // 아이템 블록 랜덤 설정
        let itemType = ITEM_NONE;
        if(Math.random() * 100 < ITEM_BLOCK_CHANCE) {
          // 아이템 중 하나 랜덤 선택 (1~6)
          itemType = Math.floor(Math.random() * 6) + 1;
        }
        bricks[c][r] = {
          x: 0,
          y: 0,
          status: 1,
          color: getRandomBrickColor(),
          item: itemType
        };
      }
    }
  }

  // 무작위 벽돌 색상 선택
  function getRandomBrickColor() {
    const colors = [
      "#e74c3c", // red
      "#f39c12", // orange
      "#f1c40f", // yellow
      "#27ae60", // green
      "#2980b9", // blue
      "#8e44ad", // purple
      "#2c3e50"  // dark blue
    ];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  // 점수, 레벨, 최고점 업데이트
  function updateScoreboard() {
    scoreElem.textContent = score;
    highscoreElem.textContent = highscore;
    levelElem.textContent = level;
  }

  // 벽돌 그리기
  function drawBricks() {
    for(let c = 0; c < brickColumnCount; c++) {
      for(let r = 0; r < brickRowCount; r++) {
        let b = bricks[c][r];
        if(b.status === 1) {
          let brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
          let brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
          b.x = brickX;
          b.y = brickY;

          ctx.fillStyle = b.color;
          ctx.fillRect(brickX, brickY, brickWidth, brickHeight);

          if(b.item !== ITEM_NONE) {
            ctx.fillStyle = "#fff";
            ctx.font = "bold 16px Arial";
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            let itemChar = getItemChar(b.item);
            ctx.fillText(itemChar, brickX + brickWidth/2, brickY + brickHeight/2);
          }

          ctx.strokeStyle = "#000";
          ctx.strokeRect(brickX, brickY, brickWidth, brickHeight);
        }
      }
    }
  }

  // 아이템 아이콘 표시용 문자
  function getItemChar(item) {
    switch(item) {
      case ITEM_PADDLE_EXPAND: return "↔";  // 확장
      case ITEM_PADDLE_SHRINK: return "⇎";  // 축소
      case ITEM_SCORE_BONUS: return "+";
      case ITEM_BALL_SPEED_SLOW: return "🐢";
      case ITEM_BALL_SPEED_FAST: return "⚡";
      case ITEM_BALL_EXTRA: return "⚾";
      default: return "";
    }
  }

  // 패들 그리기
  function drawPaddle() {
    ctx.fillStyle = "#fff";
    ctx.fillRect(paddleX, canvas.height - paddleHeight - 5, paddleWidth, paddleHeight);
  }

  // 공 그리기
  function drawBall(ball) {
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    ctx.fillStyle = "#ffdd55";
    ctx.fill();
    ctx.closePath();
  }

  // 충돌 감지 및 처리
  function collisionDetection() {
    balls.forEach((ball, ballIdx) => {
      for(let c = 0; c < brickColumnCount; c++) {
        for(let r = 0; r < brickRowCount; r++) {
          let b = bricks[c][r];
          if(b.status === 1) {
            if(ball.x > b.x && ball.x < b.x + brickWidth &&
               ball.y > b.y && ball.y < b.y + brickHeight) {
              ball.dy = -ball.dy;

              // 벽돌 깨짐
              b.status = 0;
              score += 10;
              if(score > highscore) {
                highscore = score;
                localStorage.setItem("brickBreakerHighscore", highscore);
              }

              hitSound.currentTime = 0;
              hitSound.play();

              // 아이템 블록이면 효과 적용
              if(b.item !== ITEM_NONE) {
                applyItemEffect(b.item);
              }

              // 레벨업 및 벽돌 재생성
              if(score > level * 100) {
                level++;
                resetBricks();
              }

              // 모든 벽돌 제거 시 다시 생성
              if(isAllBricksCleared()) {
                resetBricks();
              }

              updateScoreboard();
            }
          }
        }
      }
    });
  }

  // 모든 벽돌 제거 체크
  function isAllBricksCleared() {
    for(let c = 0; c < brickColumnCount; c++) {
      for(let r = 0; r < brickRowCount; r++) {
        if(bricks[c][r].status === 1) return false;
      }
    }
    return true;
  }

  // 아이템 효과 적용
  function applyItemEffect(item) {
    switch(item) {
      case ITEM_PADDLE_EXPAND:
        if(activeItems.paddleSizeModifier !== 1) {
          activeItems.paddleSizeModifier = 1;
          paddleWidth = 110;
          setTimeout(() => {
            if(!isGameOver) {
              activeItems.paddleSizeModifier = 0;
              paddleWidth = 75;
            }
          }, ITEM_DURATION);
        }
        break;
      case ITEM_PADDLE_SHRINK:
        if(activeItems.paddleSizeModifier !== -1) {
          activeItems.paddleSizeModifier = -1;
          paddleWidth = 50;
          if(paddleX + paddleWidth > canvas.width) {
            paddleX = canvas.width - paddleWidth;
          }
          setTimeout(() => {
            if(!isGameOver) {
              activeItems.paddleSizeModifier = 0;
              paddleWidth = 75;
            }
          }, ITEM_DURATION);
        }
        break;
      case ITEM_SCORE_BONUS:
        score += 50;
        if(score > highscore) {
          highscore = score;
          localStorage.setItem("brickBreakerHighscore", highscore);
        }
        break;
      case ITEM_BALL_SPEED_SLOW:
        if(activeItems.ballSpeedModifier !== -1) {
          activeItems.ballSpeedModifier = -1;
          balls.forEach(b => {
            b.dx *= 0.7;
            b.dy *= 0.7;
          });
          setTimeout(() => {
            if(!isGameOver) {
              activeItems.ballSpeedModifier = 0;
              balls.forEach(b => {
                b.dx /= 0.7;
                b.dy /= 0.7;
              });
            }
          }, ITEM_DURATION);
        }
        break;
      case ITEM_BALL_SPEED_FAST:
        if(activeItems.ballSpeedModifier !== 1) {
          activeItems.ballSpeedModifier = 1;
          balls.forEach(b => {
            b.dx *= 1.3;
            b.dy *= 1.3;
          });
          setTimeout(() => {
            if(!isGameOver) {
              activeItems.ballSpeedModifier = 0;
              balls.forEach(b => {
                b.dx /= 1.3;
                b.dy /= 1.3;
              });
            }
          }, ITEM_DURATION);
        }
        break;
      case ITEM_BALL_EXTRA:
        if(!activeItems.ballExtraActive) {
          activeItems.ballExtraActive = true;
          // 기존 공 중 첫번째 공 기준으로 새 공 추가
          let firstBall = balls[0];
          balls.push({
            x: firstBall.x,
            y: firstBall.y,
            dx: -firstBall.dx,
            dy: firstBall.dy,
            radius: firstBall.radius
          });
          // 15초 후 멀티볼 해제
          setTimeout(() => {
            if(!isGameOver) {
              activeItems.ballExtraActive = false;
              if(balls.length > 1) balls.pop();
            }
          }, ITEM_DURATION);
        }
        break;
    }
    updateScoreboard();
  }

  // 공 초기화
  function resetBalls() {
    balls = [{
      x: canvas.width/2,
      y: canvas.height - 30,
      dx: baseSpeed * (Math.random() > 0.5 ? 1 : -1),
      dy: -baseSpeed,
      radius: 8
    }];
  }

  // 게임 초기화
  function initGame() {
    score = 0;
    level = 1;
    isGameOver = false;
    controlsDisabled = false;
    paddleWidth = 75;
    paddleX = (canvas.width - paddleWidth) / 2;
    activeItems = {
      paddleSizeModifier: 0,
      ballSpeedModifier: 0,
      ballExtraActive: false,
      itemTimeouts: []
    };
    resetBalls();
    resetBricks();
    updateScoreboard();
    restartBtn.disabled = true;
    difficultySelect.disabled = false;
    startBtn.disabled = false;
  }

  // 공 이동 및 벽과 충돌 처리
  function moveBalls() {
    balls.forEach((ball, idx) => {
      ball.x += ball.dx;
      ball.y += ball.dy;

      // 좌우 벽 충돌
      if(ball.x + ball.dx > canvas.width - ball.radius || ball.x + ball.dx < ball.radius) {
        ball.dx = -ball.dx;
      }
      // 천장 충돌
      if(ball.y + ball.dy < ball.radius) {
        ball.dy = -ball.dy;
      }

      // 패들과 충돌
      if(ball.y + ball.radius > canvas.height - paddleHeight - 5) {
        if(ball.x > paddleX && ball.x < paddleX + paddleWidth) {
          ball.dy = -ball.dy;

          // 패들 위치에 따른 공 방향 조절
          let collidePoint = ball.x - (paddleX + paddleWidth/2);
          collidePoint = collidePoint / (paddleWidth/2);
          let angle = collidePoint * (Math.PI/3); // 최대 60도 각도 조절

          let speed = Math.sqrt(ball.dx*ball.dx + ball.dy*ball.dy);
          ball.dx = speed * Math.sin(angle);
          ball.dy = -speed * Math.cos(angle);

          hitSound.currentTime = 0;
          hitSound.play();
        } else if(ball.y + ball.dy > canvas.height - ball.radius) {
          // 바닥에 닿으면 게임 오버
          if(!isGameOver) {
            gameOver();
          }
        }
      }
    });
  }

  // 키 다운 이벤트
  function keyDownHandler(e) {
    if(controlsDisabled) return;
    if(e.key === "Right" || e.key === "ArrowRight") {
      rightPressed = true;
    } else if(e.key === "Left" || e.key === "ArrowLeft") {
      leftPressed = true;
    }
  }

  // 키 업 이벤트
  function keyUpHandler(e) {
    if(controlsDisabled) return;
    if(e.key === "Right" || e.key === "ArrowRight") {
      rightPressed = false;
    } else if(e.key === "Left" || e.key === "ArrowLeft") {
      leftPressed = false;
    }
  }

  // 모바일 버튼 핸들러
  btnLeft.addEventListener("touchstart", e => { e.preventDefault(); if(!controlsDisabled) mobileLeft = true; });
  btnLeft.addEventListener("touchend", e => { e.preventDefault(); mobileLeft = false; });
  btnRight.addEventListener("touchstart", e => { e.preventDefault(); if(!controlsDisabled) mobileRight = true; });
  btnRight.addEventListener("touchend", e => { e.preventDefault(); mobileRight = false; });

  // 패들 이동 처리
  function movePaddle() {
    if(rightPressed || mobileRight) {
      paddleX += 7;
      if(paddleX + paddleWidth > canvas.width) {
        paddleX = canvas.width - paddleWidth;
      }
    } else if(leftPressed || mobileLeft) {
      paddleX -= 7;
      if(paddleX < 0) {
        paddleX = 0;
      }
    }
  }

  // 게임 오버 처리
  function gameOver() {
    isGameOver = true;
    controlsDisabled = true;
    gameOverSound.currentTime = 0;
    gameOverSound.play();
    pauseBGM();
    alert("게임 오버! 점수: " + score);
    restartBtn.disabled = false;
    startBtn.disabled = true;
    difficultySelect.disabled = true;
  }

  // 게임 루프
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawBricks();
    drawPaddle();
    balls.forEach(drawBall);

    collisionDetection();
    moveBalls();
    movePaddle();

    if(!isGameOver) {
      requestAnimationFrame(draw);
    }
  }

  // BGM 제어
  function playBGM() {
    bgm.volume = 0.15;
    bgm.play().catch(() => {});
    bgmToggleBtn.textContent = "BGM OFF";
  }
  function pauseBGM() {
    bgm.pause();
    bgmToggleBtn.textContent = "BGM ON";
  }
  let bgmPlaying = false;

  // BGM 토글 버튼 클릭 이벤트
  bgmToggleBtn.addEventListener("click", () => {
    if(bgm.paused) {
      playBGM();
      bgmPlaying = true;
    } else {
      pauseBGM();
      bgmPlaying = false;
    }
  });

  // 난이도별 속도 조절
  function applyDifficulty() {
    let diff = difficultySelect.value;
    switch(diff) {
      case "easy": baseSpeed = 2; break;
      case "normal": baseSpeed = 3; break;
      case "hard": baseSpeed = 4; break;
      default: baseSpeed = 3;
    }
  }

  // 시작 버튼 클릭
  startBtn.addEventListener("click", () => {
    if(isGameOver) return;
    initGame();
    applyDifficulty();
    resetBalls();
    draw();
    playBGM();
    bgmPlaying = true;

    startBtn.disabled = true;
    restartBtn.disabled = true;
    difficultySelect.disabled = true;
  });

  // 다시하기 버튼 클릭
  restartBtn.addEventListener("click", () => {
    if(!isGameOver) return;
    initGame();
    applyDifficulty();
    resetBalls();
    draw();
    playBGM();
    bgmPlaying = true;

    restartBtn.disabled = true;
    startBtn.disabled = true;
    difficultySelect.disabled = true;
  });

  // 키보드 이벤트 등록
  document.addEventListener("keydown", keyDownHandler);
  document.addEventListener("keyup", keyUpHandler);

  // 초기 세팅
  updateScoreboard();
  resetBricks();

})();
</script>
</body>
</html>
