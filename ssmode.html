<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Easter eggs2</title>
<style>
  body {
    margin: 0; background: #222; color: #eee; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    display: flex; flex-direction: column; align-items: center; user-select:none;
  }
  canvas {
    background: #000;
    border: 3px solid white;
    display: block;
    margin-top: 10px;
    touch-action: none;
  }
  #scoreboard {
    margin-top: 10px;
    font-size: 1.2rem;
    display: flex;
    gap: 30px;
    justify-content: center;
    width: 100%;
    max-width: 480px;
  }
  #controls {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 8px;
    max-width: 480px;
  }
  button, select {
    background: #444;
    border: none;
    color: white;
    font-size: 1rem;
    padding: 8px 14px;
    border-radius: 5px;
    user-select:none;
  }
  button:disabled, select:disabled {
    opacity: 0.5;
  }
  /* 모바일 조작 버튼 */
  #mobile-controls {
    margin-top: 12px;
    display: flex;
    justify-content: center;
    gap: 20px;
    max-width: 480px;
  }
  .touch-btn {
    width: 60px;
    height: 60px;
    background: #555;
    border-radius: 10px;
    color: white;
    font-size: 1.8rem;
    line-height: 60px;
    text-align: center;
    user-select:none;
    -webkit-tap-highlight-color: transparent;
    touch-action: none;
  }
  @media (max-width: 480px) {
    canvas {
      width: 100vw;
      height: calc(100vw * 2/3);
      max-height: 320px;
    }
  }
</style>
</head>
<body>

<h1>벽돌깨기 게임</h1>

<div id="scoreboard">
  <div>점수: <span id="score">0</span></div>
  <div>최고점수: <span id="highscore">0</span></div>
  <div>레벨: <span id="level">1</span></div>
</div>

<canvas id="gameCanvas" width="480" height="320"></canvas>

<div id="controls">
  <select id="difficulty">
    <option value="easy">쉬움</option>
    <option value="normal" selected>보통</option>
    <option value="hard">어려움</option>
  </select>
  <button id="startBtn">시작하기</button>
  <button id="restartBtn" disabled>다시하기</button>
  <button id="bgmToggleBtn">BGM ON</button>
</div>

<div id="mobile-controls">
  <div id="btnLeft" class="touch-btn">◀</div>
  <div id="btnRight" class="touch-btn">▶</div>
</div>

<audio id="hitSound" src="ads/linebroken1.wav" preload="auto"></audio>
<audio id="gameOverSound" src="ads/linebroken2.wav" preload="auto"></audio>
<audio id="itemSound" src="ads/linebroken1.wav" preload="auto"></audio>
<audio id="bgm" src="ads/Tetris.mp3" preload="auto" loop></audio>

<script>
(() => {
  const canvas = document.getElementById("gameCanvas");
  const ctx = canvas.getContext("2d");

  const scoreSpan = document.getElementById("score");
  const highScoreSpan = document.getElementById("highscore");
  const levelSpan = document.getElementById("level");

  const startBtn = document.getElementById("startBtn");
  const restartBtn = document.getElementById("restartBtn");
  const difficultySelect = document.getElementById("difficulty");
  const bgmToggleBtn = document.getElementById("bgmToggleBtn");

  const btnLeft = document.getElementById("btnLeft");
  const btnRight = document.getElementById("btnRight");

  const hitSound = document.getElementById("hitSound");
  const gameOverSound = document.getElementById("gameOverSound");
  const itemSound = document.getElementById("itemSound");
  const bgm = document.getElementById("bgm");

  const ROWS = 5;
  const COLS = 9;
  const BRICK_WIDTH = 48;
  const BRICK_HEIGHT = 18;
  const BRICK_PADDING = 6;
  const BRICK_OFFSET_TOP = 30;
  const BRICK_OFFSET_LEFT = 16;

  const PADDLE_HEIGHT = 10;
  let paddleWidth = 75;

  let score = 0;
  let highScore = 0;
  let level = 1;

  let balls = [];
  let bricks = [];

  let paddleX;
  let rightPressed = false;
  let leftPressed = false;
  let mobileRight = false;
  let mobileLeft = false;

  let isGameOver = false;
  let controlsDisabled = false;

  let baseSpeed = 3;

  let activeItems = {
    paddleSizeModifier: 0,
    ballSpeedModifier: 0,
    ballExtraActive: false,
    itemTimeouts: []
  };

  const ITEM_DURATION = 15000; // 아이템 지속 시간 (15초)

  // 다양한 색깔의 벽돌 종류 및 아이템
  const brickColors = [
    "#ff5555", "#55ff55", "#5555ff", "#ffff55", "#ff55ff", "#55ffff"
  ];

  // 아이템 종류
  const ITEM_TYPES = [
    "paddleExpand",
    "paddleShrink",
    "scoreBonus",
    "ballSpeedSlow",
    "ballSpeedFast",
    "ballExtra"
  ];

  // 최고점수 로컬스토리지 불러오기
  function loadHighScore() {
    const saved = localStorage.getItem("brickBreakerHighScore");
    highScore = saved ? parseInt(saved) : 0;
    highScoreSpan.textContent = highScore;
  }

  // 최고점수 저장
  function saveHighScore() {
    if(score > highScore) {
      highScore = score;
      localStorage.setItem("brickBreakerHighScore", highScore);
      highScoreSpan.textContent = highScore;
    }
  }

  // 벽돌 초기화 및 랜덤 아이템 포함
  function resetBricks() {
    bricks = [];
    for(let r=0; r<ROWS; r++) {
      for(let c=0; c<COLS; c++) {
        let hasItem = Math.random() < 0.15; // 15% 확률로 아이템 포함
        let item = hasItem ? ITEM_TYPES[Math.floor(Math.random() * ITEM_TYPES.length)] : null;
        bricks.push({
          x: BRICK_OFFSET_LEFT + c * (BRICK_WIDTH + BRICK_PADDING),
          y: BRICK_OFFSET_TOP + r * (BRICK_HEIGHT + BRICK_PADDING),
          status: 1,
          color: brickColors[Math.floor(Math.random() * brickColors.length)],
          item: item
        });
      }
    }
  }

  // 공 초기화
  function resetBalls() {
    balls = [{
      x: canvas.width/2,
      y: canvas.height - 30,
      dx: baseSpeed * (Math.random() > 0.5 ? 1 : -1),
      dy: -baseSpeed,
      radius: 8
    }];
  }

  // 점수판 업데이트
  function updateScoreboard() {
    scoreSpan.textContent = score;
    levelSpan.textContent = level;
    saveHighScore();
  }

  // 벽돌 그리기
  function drawBricks() {
    bricks.forEach(brick => {
      if(brick.status === 1) {
        ctx.fillStyle = brick.color;
        ctx.fillRect(brick.x, brick.y, BRICK_WIDTH, BRICK_HEIGHT);
        if(brick.item) {
          // 아이템 마크 작게 표시
          ctx.fillStyle = "white";
          ctx.font = "14px Arial";
          ctx.fillText("★", brick.x + BRICK_WIDTH/2 - 7, brick.y + BRICK_HEIGHT - 4);
        }
      }
    });
  }

  // 패들 그리기
  function drawPaddle() {
    ctx.fillStyle = "#fff";
    ctx.fillRect(paddleX, canvas.height - PADDLE_HEIGHT, paddleWidth, PADDLE_HEIGHT);
  }

  // 공 그리기
  function drawBall(ball) {
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI*2);
    ctx.fillStyle = "#eee";
    ctx.fill();
    ctx.closePath();
  }

  // 충돌 체크
  function collisionDetection() {
    balls.forEach(ball => {
      bricks.forEach(brick => {
        if(brick.status === 1) {
          if(ball.x > brick.x && ball.x < brick.x + BRICK_WIDTH &&
             ball.y - ball.radius < brick.y + BRICK_HEIGHT &&
             ball.y + ball.radius > brick.y) {
            ball.dy = -ball.dy;

            brick.status = 0;

            // 점수 증가
            score += 10;

            // 아이템이 있으면 발동
            if(brick.item) {
              activateItem(brick.item);
              itemSound.currentTime = 0;
              itemSound.play().catch(() => {});
            }

            // 모든 벽돌이 없어졌으면 재생성 및 레벨 업
            if(bricks.every(b => b.status === 0)) {
              level++;
              resetBricks();
              // 레벨에 따라 난이도 자동 조정 (속도 증가)
              baseSpeed = 2 + level * 0.5;
              // 모든 공 속도 업데이트
              balls.forEach(b => {
                b.dx = b.dx > 0 ? baseSpeed : -baseSpeed;
                b.dy = -baseSpeed;
              });
            }

            updateScoreboard();

            hitSound.currentTime = 0;
            hitSound.play().catch(() => {});

          }
        }
      });
    });
  }

  // 아이템 발동
  function activateItem(type) {
    switch(type) {
      case "paddleExpand":
        activeItems.paddleSizeModifier = 30;
        paddleWidth = 75 + activeItems.paddleSizeModifier;
        setTimeout(() => {
          activeItems.paddleSizeModifier = 0;
          paddleWidth = 75;
        }, ITEM_DURATION);
        break;
      case "paddleShrink":
        activeItems.paddleSizeModifier = -20;
        paddleWidth = Math.max(30, 75 + activeItems.paddleSizeModifier);
        setTimeout(() => {
          activeItems.paddleSizeModifier = 0;
          paddleWidth = 75;
        }, ITEM_DURATION);
        break;
      case "scoreBonus":
        score += 50;
        updateScoreboard();
        break;
      case "ballSpeedSlow":
        activeItems.ballSpeedModifier = -1;
        balls.forEach(b => {
          b.dx *= 0.7;
          b.dy *= 0.7;
        });
        setTimeout(() => {
          activeItems.ballSpeedModifier = 0;
          balls.forEach(b => {
            let signX = b.dx > 0 ? 1 : -1;
            let signY = b.dy > 0 ? 1 : -1;
            b.dx = signX * baseSpeed;
            b.dy = -baseSpeed;
          });
        }, ITEM_DURATION);
        break;
      case "ballSpeedFast":
        activeItems.ballSpeedModifier = 1;
        balls.forEach(b => {
          b.dx *= 1.5;
          b.dy *= 1.5;
        });
        setTimeout(() => {
          activeItems.ballSpeedModifier = 0;
          balls.forEach(b => {
            let signX = b.dx > 0 ? 1 : -1;
            let signY = b.dy > 0 ? 1 : -1;
            b.dx = signX * baseSpeed;
            b.dy = -baseSpeed;
          });
        }, ITEM_DURATION);
        break;
      case "ballExtra":
        if(!activeItems.ballExtraActive) {
          activeItems.ballExtraActive = true;
          // 공 1개 추가
          balls.push({
            x: balls[0].x,
            y: balls[0].y,
            dx: -balls[0].dx,
            dy: balls[0].dy,
            radius: 8
          });
          // 멀티볼 영구 유지 (타이머 제거)
          // 게임 오버 될 때까지 유지
        }
        break;
    }
  }

  // 공 움직임 처리
  function moveBalls() {
    balls.forEach(ball => {
      ball.x += ball.dx;
      ball.y += ball.dy;

      // 벽 충돌 (좌우)
      if(ball.x + ball.dx > canvas.width - ball.radius || ball.x + ball.dx < ball.radius) {
        ball.dx = -ball.dx;
      }

      // 천장 충돌
      if(ball.y + ball.dy < ball.radius) {
        ball.dy = -ball.dy;
      }

      // 패들과 충돌 및 바닥 닿음 감지
      if(ball.y + ball.radius >= canvas.height - PADDLE_HEIGHT) {
        if(ball.x > paddleX && ball.x < paddleX + paddleWidth) {
          ball.dy = -Math.abs(ball.dy);
          hitSound.currentTime = 0;
          hitSound.play().catch(() => {});
        } else if(ball.y + ball.dy > canvas.height - ball.radius) {
          // 바닥 닿음: 게임오버
          if(!isGameOver) {
            gameOver();
          }
        }
      }
    });

    // 여러 공 중 바닥에 닿은 공 제거는 안 함 (게임 오버 처리만 함)
  }

  // 패들 움직임 처리
  function movePaddle() {
    if(controlsDisabled) return;
    if(rightPressed || mobileRight) {
      paddleX += 7;
      if(paddleX + paddleWidth > canvas.width) paddleX = canvas.width - paddleWidth;
    } else if(leftPressed || mobileLeft) {
      paddleX -= 7;
      if(paddleX < 0) paddleX = 0;
    }
  }

  // 그리기 함수
  function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    drawBricks();
    drawPaddle();
    balls.forEach(drawBall);

    collisionDetection();
    moveBalls();
    movePaddle();

    if(!isGameOver) {
      requestAnimationFrame(draw);
    }
  }

  // 게임 오버 처리
  function gameOver() {
    isGameOver = true;
    controlsDisabled = true;
    restartBtn.disabled = false;
    difficultySelect.disabled = false; // 게임 오버시 난이도 선택 가능
    gameOverSound.currentTime = 0;
    gameOverSound.play().catch(() => {});
  }

  // 게임 시작 초기화
  function startGame() {
    isGameOver = false;
    controlsDisabled = false;
    restartBtn.disabled = true;
    difficultySelect.disabled = true; // 게임 중 난이도 변경 불가

    // 점수, 레벨 초기화
    score = 0;
    level = 1;

    // 난이도에 따라 baseSpeed 설정
    applyDifficulty();

    resetBricks();
    resetBalls();

    // 패들 초기 위치
    paddleX = (canvas.width - paddleWidth) / 2;

    // 키 상태 초기화
    rightPressed = false;
    leftPressed = false;
    mobileRight = false;
    mobileLeft = false;

    activeItems = {
      paddleSizeModifier: 0,
      ballSpeedModifier: 0,
      ballExtraActive: false,
      itemTimeouts: []
    };

    updateScoreboard();

    draw();

    // BGM 자동 재생는 BGM 버튼 누르기 전까지 안 함 (브라우저 정책)
  }

  // 재시작
  function restartGame() {
    startGame();
  }

  // 난이도에 따른 baseSpeed 적용
  function applyDifficulty() {
    let diff = difficultySelect.value;
    switch(diff) {
      case "easy": baseSpeed = 2; break;
      case "normal": baseSpeed = 3.5; break;
      case "hard": baseSpeed = 5; break;
      default: baseSpeed = 3.5;
    }
  }

  // 배경음악 토글
  function toggleBgm() {
    if(bgm.paused) {
      bgm.play().catch(() => {});
      bgmToggleBtn.textContent = "BGM OFF";
    } else {
      bgm.pause();
      bgmToggleBtn.textContent = "BGM ON";
    }
  }

  // 키보드 이벤트
  window.addEventListener("keydown", e => {
    if(controlsDisabled) return;
    if(e.key === "ArrowRight") rightPressed = true;
    if(e.key === "ArrowLeft") leftPressed = true;
  });
  window.addEventListener("keyup", e => {
    if(e.key === "ArrowRight") rightPressed = false;
    if(e.key === "ArrowLeft") leftPressed = false;
  });

  // 모바일 터치 이벤트
  btnLeft.addEventListener("touchstart", e => {
    e.preventDefault();
    if(controlsDisabled) return;
    mobileLeft = true;
  });
  btnLeft.addEventListener("touchend", e => {
    e.preventDefault();
    mobileLeft = false;
  });
  btnLeft.addEventListener("touchcancel", e => {
    e.preventDefault();
    mobileLeft = false;
  });

  btnRight.addEventListener("touchstart", e => {
    e.preventDefault();
    if(controlsDisabled) return;
    mobileRight = true;
  });
  btnRight.addEventListener("touchend", e => {
    e.preventDefault();
    mobileRight = false;
  });
  btnRight.addEventListener("touchcancel", e => {
    e.preventDefault();
    mobileRight = false;
  });

  // 버튼 이벤트 연결
  startBtn.addEventListener("click", () => {
    startGame();
  });
  restartBtn.addEventListener("click", () => {
    restartGame();
  });
  difficultySelect.addEventListener("change", () => {
    if(!isGameOver) {
      applyDifficulty();
      // 게임 중 변경 시 공 속도 실시간 적용
      balls.forEach(b => {
        let signX = b.dx > 0 ? 1 : -1;
        let signY = b.dy > 0 ? 1 : -1;
        b.dx = signX * baseSpeed;
        b.dy = -baseSpeed;
      });
    }
  });

  bgmToggleBtn.addEventListener("click", () => {
    toggleBgm();
  });

  // 초기화
  paddleX = (canvas.width - paddleWidth) / 2;
  loadHighScore();

})();
</script>

</body>
</html>
